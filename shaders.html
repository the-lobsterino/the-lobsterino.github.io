<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üêæ Shader Lab</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;600;900&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --pink: #ff2d95;
      --cyan: #00f5ff;
      --dark: #0a0a0f;
      --glass: rgba(255,255,255,0.04);
    }
    
    html, body { height: 100%; overflow: hidden; }
    
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--dark);
      color: #fff;
    }
    
    /* HOME */
    .home {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 16px;
    }
    
    .home.hidden { display: none; }
    
    .home-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .home-header a {
      color: var(--cyan);
      text-decoration: none;
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
    }
    
    .home-header h1 {
      font-size: 1.4rem;
      background: linear-gradient(135deg, var(--pink), var(--cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .home-header .credit {
      margin-left: auto;
      font-size: 0.7rem;
      opacity: 0.6;
    }
    
    .home-header .credit a { color: var(--pink); }
    
    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      overflow-y: auto;
    }
    
    .card {
      aspect-ratio: 16/10;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      position: relative;
      transition: transform 0.2s, border-color 0.2s;
    }
    
    .card:hover { transform: scale(1.03); border-color: var(--cyan); }
    .card canvas { width: 100%; height: 100%; display: block; }
    .card-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 6px 8px;
      background: linear-gradient(transparent, rgba(0,0,0,0.9));
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
    }
    
    /* DETAIL */
    .detail {
      position: fixed;
      inset: 0;
      background: var(--dark);
      display: none;
      flex-direction: column;
    }
    
    .detail.active { display: flex; }
    
    .detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .back-btn {
      background: none;
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Space Mono', monospace;
      font-size: 0.75rem;
    }
    
    .back-btn:hover { border-color: var(--cyan); color: var(--cyan); }
    
    .detail-title { font-size: 1.2rem; font-weight: 600; }
    .detail-author {
      margin-left: auto;
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
    }
    .detail-author a { color: var(--cyan); }
    
    .detail-body {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 12px;
      padding: 12px;
      overflow: hidden;
    }
    
    .shader-view {
      border-radius: 10px;
      overflow: hidden;
      background: #000;
      position: relative;
    }
    
    .shader-view canvas { width: 100%; height: 100%; display: block; }
    
    .step-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      padding: 4px 10px;
      border-radius: 15px;
      font-family: 'Space Mono', monospace;
      font-size: 0.65rem;
    }
    
    .steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }
    
    .step {
      background: var(--glass);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .step:hover { border-color: rgba(255,255,255,0.2); }
    .step.active { border-color: var(--cyan); background: rgba(0,245,255,0.08); }
    
    .step-num {
      display: inline-block;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      background: var(--pink);
      border-radius: 50%;
      font-size: 0.65rem;
      font-weight: 700;
      margin-right: 6px;
    }
    
    .step.active .step-num { background: var(--cyan); color: var(--dark); }
    .step-title { font-weight: 600; font-size: 0.85rem; }
    .step-desc { margin-top: 6px; font-size: 0.7rem; opacity: 0.65; line-height: 1.4; }
    .step-code {
      margin-top: 8px;
      background: rgba(0,0,0,0.4);
      padding: 8px;
      border-radius: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 0.5rem;
      line-height: 1.5;
      color: #888;
      white-space: pre-wrap;
      max-height: 80px;
      overflow: auto;
      display: none;
    }
    .step.active .step-code { display: block; }
    
    @media (max-width: 700px) {
      .detail-body { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="home" id="home">
    <div class="home-header">
      <a href="index.html">‚Üê back</a>
      <h1>Shader Lab</h1>
      <div class="credit">inspired by <a href="https://xordev.com/arsenal" target="_blank">@XorDev</a></div>
    </div>
    <div class="grid" id="grid"></div>
  </div>
  
  <div class="detail" id="detail">
    <div class="detail-header">
      <button class="back-btn" onclick="goHome()">‚Üê Back</button>
      <div class="detail-title" id="detailTitle"></div>
      <div class="detail-author" id="detailAuthor"></div>
    </div>
    <div class="detail-body">
      <div class="shader-view">
        <canvas id="detailCanvas"></canvas>
        <div class="step-badge" id="stepBadge"></div>
      </div>
      <div class="steps" id="steps"></div>
    </div>
  </div>
  
  <script>
    let shaders = [], gridCtx = {}, detailCtx = null, current = null, step = 0;
    
    function mkShader(canvas, frag) {
      const gl = canvas.getContext('webgl');
      if (!gl) return null;
      const vs = `attribute vec2 p; void main() { gl_Position = vec4(p, 0.0, 1.0); }`;
      function compile(t, s) { const sh = gl.createShader(t); gl.shaderSource(sh, s); gl.compileShader(sh); return sh; }
      const prog = gl.createProgram();
      gl.attachShader(prog, compile(gl.VERTEX_SHADER, vs));
      gl.attachShader(prog, compile(gl.FRAGMENT_SHADER, frag));
      gl.linkProgram(prog);
      if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) return null;
      gl.useProgram(prog);
      const buf = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buf);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,1,-1,-1,1,1,1]), gl.STATIC_DRAW);
      const pos = gl.getAttribLocation(prog, 'p');
      gl.enableVertexAttribArray(pos);
      gl.vertexAttribPointer(pos, 2, gl.FLOAT, false, 0, 0);
      return { gl, t: gl.getUniformLocation(prog, 't'), r: gl.getUniformLocation(prog, 'r') };
    }
    
    function renderGrid() {
      document.getElementById('grid').innerHTML = shaders.map((s, i) => `
        <div class="card" onclick="openShader(${i})">
          <canvas id="gc${i}"></canvas>
          <div class="card-name">${s.name}</div>
        </div>
      `).join('');
      shaders.forEach((s, i) => {
        const c = document.getElementById(`gc${i}`);
        const rect = c.parentElement.getBoundingClientRect();
        c.width = rect.width * devicePixelRatio;
        c.height = rect.height * devicePixelRatio;
        gridCtx[i] = mkShader(c, s.steps[s.steps.length - 1].code);
      });
    }
    
    function openShader(i) {
      current = i; step = 0;
      const s = shaders[i];
      document.getElementById('home').classList.add('hidden');
      document.getElementById('detail').classList.add('active');
      document.getElementById('detailTitle').textContent = s.name;
      document.getElementById('detailAuthor').innerHTML = `<a href="${s.link}" target="_blank">${s.author}</a>`;
      renderSteps();
      selectStep(0);
    }
    
    function renderSteps() {
      const s = shaders[current];
      document.getElementById('steps').innerHTML = s.steps.map((st, i) => `
        <div class="step ${i === 0 ? 'active' : ''}" onclick="selectStep(${i})" id="st${i}">
          <span class="step-num">${i + 1}</span>
          <span class="step-title">${st.title}</span>
          <div class="step-desc">${st.desc}</div>
          <div class="step-code">${esc(st.code)}</div>
        </div>
      `).join('');
    }
    
    function selectStep(i) {
      step = i;
      const s = shaders[current];
      document.querySelectorAll('.step').forEach((el, j) => el.classList.toggle('active', j === i));
      document.getElementById('stepBadge').textContent = `${i + 1} / ${s.steps.length}`;
      const canvas = document.getElementById('detailCanvas');
      canvas.width = canvas.parentElement.offsetWidth * devicePixelRatio;
      canvas.height = canvas.parentElement.offsetHeight * devicePixelRatio;
      detailCtx = mkShader(canvas, s.steps[i].code);
    }
    
    function goHome() {
      document.getElementById('home').classList.remove('hidden');
      document.getElementById('detail').classList.remove('active');
      detailCtx = null; current = null;
    }
    
    function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    
    document.onkeydown = (e) => {
      if (current === null) return;
      if (e.key === 'Escape') goHome();
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') selectStep(Math.min(step + 1, shaders[current].steps.length - 1));
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') selectStep(Math.max(step - 1, 0));
    };
    
    function loop(time) {
      time *= 0.001;
      Object.entries(gridCtx).forEach(([i, ctx]) => {
        if (ctx) {
          const c = document.getElementById(`gc${i}`);
          if (c) { ctx.gl.viewport(0, 0, c.width, c.height); ctx.gl.uniform1f(ctx.t, time); ctx.gl.uniform2f(ctx.r, c.width, c.height); ctx.gl.drawArrays(ctx.gl.TRIANGLE_STRIP, 0, 4); }
        }
      });
      if (detailCtx) {
        const c = document.getElementById('detailCanvas');
        detailCtx.gl.viewport(0, 0, c.width, c.height);
        detailCtx.gl.uniform1f(detailCtx.t, time);
        detailCtx.gl.uniform2f(detailCtx.r, c.width, c.height);
        detailCtx.gl.drawArrays(detailCtx.gl.TRIANGLE_STRIP, 0, 4);
      }
      requestAnimationFrame(loop);
    }
    
    window.addEventListener('resize', () => { if (current !== null) selectStep(step); });
    
    fetch('data/shaders.json').then(r => r.json()).then(data => { shaders = data; renderGrid(); loop(0); });
  </script>
</body>
</html>
